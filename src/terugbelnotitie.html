<!doctype html>
    <!-- Er worden 1 variable gebruikt, ${serverName} die verwijst naar vars die in de Layer7 policy gevuld zijn-->
    <!-- in runtime worden die vars vervangen door de daadwerkelijke inhoud, en dan wordt deze hele pagina naar de browser gestuurd-->
<html lang="nl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://componenten.nijmegen.nl/v2/css/bootstrap.min.css">
    <!-- Material Design Bootstrap combined with custom styles -->
    <link rel="stylesheet" href="https://componenten.nijmegen.nl/v2/css/main.css">

    <title>Terugbelnotitie</title>

    <style>
        body {padding: 1rem;}
    </style>
<style>
    body { padding: 150px 0 0; }
    main .row { padding: 20px 0; }
    footer.page-footer { margin-top: 50px; }
	#feedback{
		font-size:24px;
		padding-bottom:15px;
		
	}
	.nav-item{display:none};

</style>
</head>
<body>

<nav class="navbar fixed-top navbar-expand-lg scrolling-navbar navbar-primary">
    <div class="container">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" href="/">
            <div class="navbar-brand-container">
                <img src="https://componenten.nijmegen.nl/v2/img/beeldmerklabelwit.svg" class="logo-labeled" alt="Logo Nijmegen">
                <img src="https://componenten.nijmegen.nl/v2/img/beeldmerkwit.svg" class="logo" alt="Logo Nijmegen">
            </div>
        </a>
        <div class="collapse navbar-collapse" id="navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a href="#section-1" class="nav-link"></a>
                </li>
            </ul>
            <form action="https://www.nijmegen.nl" class="form-inline ml-auto">
                <label for="oi-query" class="sr-only">Zoeken</label>
                <input class="form-control" id="oi-query" type="text" placeholder="Zoeken" autocomplete="off">
                <button class="btn-search"><i class="mdi mdi-magnify" aria-hidden="true"></i></button>
            </form>
        </div>
    </div>
</nav>

<main>
    <div class="container">
		<H1>Demo terugbelnotitie</H1>
		<div class="row">
            <div class="col-12">
				<div id="feedback"></div>
				<div id="qrcode"></div>

			</div>
		</div>
		<form id="frm1" action="${serverName}/terugbelnotitie" method="POST">
            <div class="row">
                <div class="col-12">
                    <div class="md-form">
                        <input type="text" value="Uitkering WWI" name="onderwerp" id="onderwerp" class="form-control" placeholder="">
                        <label for="onderwerp">Onderwerp</label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="md-form">
                        <input type="text" value="Ik word gekort op mijn uitkering" name="toelichting" id="toelichting" class="form-control" placeholder="">
                        <label for="toelichting">Toelichting</label>					
                    </div>
                </div>
            </div>

           <div class="row">
                <div class="col-12">
                    <div class="md-form">
                        <input type="text" value="06-12345678" name="telefoon" id="telefoon" class="form-control" placeholder="">
                        <label for="telefoon">Telefoon nr</label>					
                    </div>
                </div>
            </div>

			
             <div class="row">
                <div class="col-12">
					<input type="hidden" name="text-to-sign" value="Ik wil terug worden gebeld">
                    <button type="submit" class="btn btn-primary">Verzenden</button>
                </div>
            </div>			
			
        </form>
    </div>
</main>



<!-- SCRIPTS -->
<!-- JQuery -->
<script src="https://componenten.nijmegen.nl/v2/js/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script src="https://componenten.nijmegen.nl/v2/js/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script src="https://componenten.nijmegen.nl/v2/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script src="https://componenten.nijmegen.nl/v2/js/mdb.min.js"></script>

<script src="https://www.openindex.io/js/openindex.69694b9315763c81.js"></script>

<!-- IRMA -->
<script type="text/javascript" src="${serverName}/irma/issue/qrcode-min.js"></script>
<script type="text/javascript" src="${serverName}/irma/issue/irma-nijmegen.js"></script>


<script>
//Custom
var form = document.getElementById("frm1");

form.onsubmit = function (e) {
  // stop the regular form submission
  e.preventDefault();

 console.log("start onsubmit"); 
  
onderwerp = $('input[name="onderwerp"]').val();
toelichting = $('input[name="toelichting"]').val();
telefoon = $('input[name="telefoon"]').val();

var tekst = "Ik wil terug gebeld worden op telefoon nummer " + telefoon + " over " + onderwerp + ". Toelichting: " + toelichting ;

$('input[name="text-to-sign"]').val(tekst);

  var data = $(form).serializeArray().reduce(function(obj, item) {
    obj[item.name] = item.value;
    return obj;
	}, {});
 
  
   console.log('data : ' + JSON.stringify(data));


  
  var xhr = new XMLHttpRequest();
  xhr.open(form.method, form.action, true);
  xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

  xhr.send(JSON.stringify(data));

  xhr.onreadystatechange = function () {
	if (xhr.readyState === 4 && xhr.status === 200) {
		jwt=xhr.responseText;
		ojwt=JSON.parse(jwt);
		console.log("Ajax response: " + jwt);
		new QRCode(document.getElementById("qrcode"), jwt);
		
        detectUserAgent();//nodig om op mobile devices routing naar IRMA app te regelen

        signFromQr(ojwt, success_fun, showWarning, showError);
		document.getElementById("frm1").style.display="none";
		feedback("Scan onderstaande QR code met uw IRMA app.")
	}
  }  
  
} 

var showWarning = function (errorcode, msg) {
	//var x = document.getElementById("qrcode");
	//x.style.display = "none";
	log(Loglevel.Warn, msg);
	feedback(msg);
};
var showError = function (errorcode, msg) {
	//var x = document.getElementById("qrcode");
   // x.style.display = "none";
	log(Loglevel.Error, msg);
	feedback(msg);
};
var success_fun = function (data) {
	var x = document.getElementById("qrcode");
	x.style.display = "none";
	log(Loglevel.Info, "redirect naar volgende L7 policy waar bevestiging geregeld wordt");
	feedback("Uw verzoek is verzonden. U wordt zo spoedig mogelijk terug gebeld op " + telefoon + " over " + onderwerp + ".");
	//feedback("redirect naar volgende L7 policy waar bevestiging geregeld wordt");

};

function returnProofJWT(jwt){

var xhr = new XMLHttpRequest();
  xhr.open("POST", "${serverName}/terugbelnotitie/jwt", true);
  xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

  xhr.send(jwt);

  xhr.onreadystatechange = function () {
	if (xhr.readyState === 4 && xhr.status === 200) {

	}
  }  	
	
	

}

function feedback(txt){
	$("#feedback").html(txt);
}

</script>





</body>
</html>
